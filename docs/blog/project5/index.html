<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Benjamin (songhao)Ma's Website – index</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Benjamin (songhao)Ma’s Website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html" rel="" target="">
 <span class="menu-text">resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Blog.html" rel="" target="">
 <span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#project-5-data-wranging-for-customers-demand-estimation" id="toc-project-5-data-wranging-for-customers-demand-estimation" class="nav-link active" data-scroll-target="#project-5-data-wranging-for-customers-demand-estimation">Project 5: Data Wranging for Customers Demand Estimation</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#project-overview" id="toc-project-overview" class="nav-link" data-scroll-target="#project-overview">Project Overview</a></li>
  <li><a href="#import-data" id="toc-import-data" class="nav-link" data-scroll-target="#import-data">Import Data</a></li>
  <li><a href="#create-dataset-for-mnl" id="toc-create-dataset-for-mnl" class="nav-link" data-scroll-target="#create-dataset-for-mnl">Create Dataset for MNL —–</a></li>
  <li><a href="#some-observations" id="toc-some-observations" class="nav-link" data-scroll-target="#some-observations">Some Observations</a></li>
  <li><a href="#testing-for-the-better-fitting-hypothesis" id="toc-testing-for-the-better-fitting-hypothesis" class="nav-link" data-scroll-target="#testing-for-the-better-fitting-hypothesis">Testing for the Better Fitting Hypothesis</a></li>
  <li><a href="#some-observations-1" id="toc-some-observations-1" class="nav-link" data-scroll-target="#some-observations-1">Some Observations</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="project-5-data-wranging-for-customers-demand-estimation" class="level1">
<h1>Project 5: Data Wranging for Customers Demand Estimation</h1>
<p>This project is showing how I did data wrangling for the mlogit package to support further researching topics in later projects. it’s a boring topic and feel free to ignore it.</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The Multinomial Logit Model (MNL) is a predictive modeling technique often used in demand prediction when the outcome of interest has more than two categorical outcomes. It is an extension of the logistic regression model to multiple classes. This model is particularly useful in scenarios like predicting customer choice among several products, transport mode selection, or any situation where individuals select from multiple options.</p>
<p>How the Multinomial Logit Model Works:</p>
<pre><code>1.  Probabilistic Framework: The model estimates the probabilities of each possible outcome as a function of the independent variables.
2.  Utility-Based: Each choice option is assumed to have a utility associated with it, which is modeled as a linear combination of explanatory variables.
3.  Logit Function: It uses a logit function to model the probability that a particular alternative is chosen.</code></pre>
<p>Applications in Demand Prediction:</p>
<pre><code>•   Transport Economics: Predicting the mode of transport (bus, train, car, etc.) a person might choose based on various factors like cost, time, and comfort.
•   Marketing: Determining which product a consumer is likely to purchase based on features such as price, brand, and consumer demographics.
•   Public Policy: Assessing the likelihood of individuals opting for different public services.</code></pre>
<p>Data Wrangling for Multinomial Logit Model:</p>
<p>Data wrangling, or data preprocessing, is a crucial step before applying any predictive modeling technique. Here’s how you might go about it for the Multinomial Logit Model:</p>
<pre><code>1.  Data Cleaning:
•   Missing Values: Handle missing data through imputation or removal.
•   Outliers: Identify and treat outliers as they can skew the results.
2.  Data Transformation:
•   Normalization/Standardization: Scale numeric features to have a mean of zero 
  and a standard deviation of one, or transform them to range between 0 and 1.
•   Encoding Categorical Variables: Convert categorical variables into dummy/indicator 
  variables.For instance, using one-hot encoding.
3.  Feature Selection:
•   Identify which features are most relevant to the prediction. This can be achieved 
  through statistical tests, domain knowledge, or machine learning feature selection 
  techniques.
4.  Data Integration:
•   Combine data from multiple sources to enrich the dataset. Ensure alignment 
  and compatibility between different data sources.
5.  Feature Engineering:
•   Create new features that can capture important information in a more useful form. 
  This might involve aggregating data, creating interaction terms, 
  or transforming variables.</code></pre>
</section>
<section id="project-overview" class="level2">
<h2 class="anchored" data-anchor-id="project-overview">Project Overview</h2>
<p>Demand modeling with archival data enables data-driven sales predictions at counterfactual characteristics(prices) MNL (usually with extensions) is the most popular demand model Micro founded Well behaved, estimable Based on clearly specified theoretical model of choice Demand parameter estimates may be biased when price is correlated with unobservables that drive demand. This is endogeneity. Can sometimes be dealt with.</p>
<p>Price endogeneity is a major issue in demand estimation: Suppose the data do not record all product attributes that vary and affect demand (eg, brand reputation, coolness, aesthetics, reliability, etc) if unobserved attributes affect both price and quantity, then predictors are correlated with errors, and we say endogeneity would bias demand estimates. This is just like the assumption in linear regression that cov(X,e)=0. in this modeling I am going to disregard endogeneity for simplicity. Instead of predict demand people usually see the product’s quantity response to a change in price.</p>
</section>
<section id="import-data" class="level2">
<h2 class="anchored" data-anchor-id="import-data">Import Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Using T-mobile customer phone data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.4.4     ✔ tibble    3.2.1
✔ lubridate 1.9.3     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlogit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: dfidx

Attaching package: 'dfidx'

The following object is masked from 'package:stats':

    filter</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>cust_dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./smartphone_customer_data.csv"</span>, <span class="at">show_col_types =</span> F)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(cust_dat)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># replace missing 'discount' values (currently NA) with empty string ("")</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>cust_dat <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">discount =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(discount), <span class="st">""</span>, discount))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1357</span>)   </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    subk <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">select</span>(gaming, chat, maps, video, social, reading)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    outk <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(subk, <span class="at">centers =</span> <span class="dv">3</span>, <span class="at">nstart =</span> <span class="dv">10</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table</span>(outk<span class="sc">$</span>cluster)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2    3 
 542 1302 1156 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    cust_dat<span class="sc">$</span>segment <span class="ot">&lt;-</span> <span class="fu">factor</span>(outk<span class="sc">$</span>cluster)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(subk, outk)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># import phone attributes     </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    phone_dat <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"./phone_dat.csv"</span>, <span class="at">show_col_types =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-dataset-for-mnl" class="level2">
<h2 class="anchored" data-anchor-id="create-dataset-for-mnl">Create Dataset for MNL —–</h2>
<p>Now we need to combine these datasets. The customer data has “n” rows and for each customer, there were 6 phones available on the market when the customer purchased their phone. So we will construct a dataset that has n*6 rows. This facilitates mlogit calculating a predicted utility for each available option for each available customer</p>
<p>I’m going to do this in three steps.</p>
<p>Step 1: loop over customers and create a dataset of the 6 available phones for that customer. This is a very flexible way to structure the data. It will be useful to us because we may need to adjust the price of a phone if it was on discount, and this adjustment is customer-specific. More generally, this is a good way to structure data for a MNL model since it would allow different customers to choose from different sets of products.</p>
<p>step 2: we will stack (ie append) these n datasets on top of each other to create the dataset with the n*6 rows.</p>
<p>Step 3: the ‘mlogit’ package that fits the MNL model requires us to create an mlogit-data object, so we’ll do that, and then we’ll feed that mlogit-data object into the mlogit() function to estimate the parameters of this model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create an empty list to store the n datasets (each dataset will have 6 rows)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    dat_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"list"</span>, <span class="at">length =</span> n)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> n, <span class="at">style =</span> <span class="dv">3</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#loop for step 1</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># get cohort, minutes, brand, and size for customer i</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>      i_cohort   <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> <span class="fu">pull</span>(years_ago)   </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      i_brand    <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> <span class="fu">pull</span>(brand)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      i_size     <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> <span class="fu">pull</span>(screen_size)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      i_discount <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> <span class="fu">pull</span>(discount)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      i_segment  <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> <span class="fu">pull</span>(segment)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      i_minutes  <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span> <span class="fu">slice</span>(i) <span class="sc">|&gt;</span> <span class="fu">pull</span>(total_minutes)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># subset the phone data to the 6 phones for the year when the customer purchased</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>      PD <span class="ot">&lt;-</span> phone_dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(years_ago <span class="sc">==</span> i_cohort)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># adjust one of the phone's price for the 10% discount, if applicable</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>      PD <span class="ot">&lt;-</span> PD <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">price =</span> price <span class="sc">-</span> (phone_id <span class="sc">==</span> i_discount) <span class="sc">*</span> price <span class="sc">*</span> <span class="fl">0.1</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># add customer id to PD</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>      PD <span class="ot">&lt;-</span> PD <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">customer_id =</span> i)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># convert the one brand variable into a set of 3 brand dummies (ie, binary variables)</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>      PD <span class="ot">&lt;-</span> PD <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">apple =</span> <span class="fu">as.integer</span>(brand <span class="sc">==</span> <span class="st">"apple"</span>),</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">huawei =</span> <span class="fu">as.integer</span>(brand <span class="sc">==</span> <span class="st">"huawei"</span>),</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">samsung =</span> <span class="fu">as.integer</span>(brand <span class="sc">==</span> <span class="st">"samsung"</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>      <span class="co"># create a binary variable to indicate the chosen phone</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># this is going to be the dependent variable in the MNL model (like "y" in OLS)</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>      PD <span class="ot">&lt;-</span> PD <span class="sc">|&gt;</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">choice =</span> (brand <span class="sc">==</span> i_brand) <span class="sc">&amp;</span> (screen_size <span class="sc">==</span> i_size)) <span class="sc">|&gt;</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">choice =</span> <span class="fu">as.integer</span>(choice))</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># add segment and total_minutes</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>      PD <span class="ot">&lt;-</span> PD <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">segment =</span> i_segment, <span class="at">total_minutes =</span> i_minutes)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>      <span class="co"># store this 6-row dataset in the i'th position of that list we initialized before the loop</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>      dat_list[[i]] <span class="ot">&lt;-</span> PD <span class="sc">|&gt;</span> <span class="fu">select</span>(</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        customer_id, phone_id, choice,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        apple, huawei, samsung,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        price, screen_size,</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        segment, total_minutes</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># clean up -- delete temporary objects from the loop that we don't need anymore</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(i, i_cohort, i_brand, i_size, i_discount, i_segment, i_minutes, PD, pb)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's take a look at two (out of the n) 6-row datasets:</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    dat_list[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 6 × 10
  customer_id phone_id choice apple huawei samsung price screen_size segment
        &lt;int&gt; &lt;chr&gt;     &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
1           1 A1            0     1      0       0   749         5.5 2      
2           1 A2            0     1      0       0   899         5.8 2      
3           1 S1            0     0      0       1   699         5.6 2      
4           1 S2            0     0      0       1   799         5.9 2      
5           1 H1            0     0      1       0   599         5.2 2      
6           1 H2            1     0      1       0   699         5.7 2      
# ℹ 1 more variable: total_minutes &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>    dat_list[<span class="dv">100</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 6 × 10
  customer_id phone_id choice apple huawei samsung price screen_size segment
        &lt;int&gt; &lt;chr&gt;     &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
1         100 A1            1     1      0       0   799         5.8 2      
2         100 A2            0     1      0       0   899         6.1 2      
3         100 S1            0     0      0       1   749         5.8 2      
4         100 S2            0     0      0       1   849         6.3 2      
5         100 H1            0     0      1       0   699         5.7 2      
6         100 H2            0     0      1       0   749         6   2      
# ℹ 1 more variable: total_minutes &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># Step 2 -----</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Stacking the n 6-row customer-specific dataframes into one big dataframe </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#(that will have n*6 rows)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rbind operates on dataframes to concatenate rows</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using do.call in order to concatenate rows within lists</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    mnl_dat <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(<span class="fu">do.call</span>(rbind, dat_list))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(dat_list)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Data frame should looks like this </span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">head</span>(mnl_dat, <span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 10
   customer_id phone_id choice apple huawei samsung price screen_size segment
         &lt;int&gt; &lt;chr&gt;     &lt;int&gt; &lt;int&gt;  &lt;int&gt;   &lt;int&gt; &lt;dbl&gt;       &lt;dbl&gt; &lt;fct&gt;  
 1           1 A1            0     1      0       0  749          5.5 2      
 2           1 A2            0     1      0       0  899          5.8 2      
 3           1 S1            0     0      0       1  699          5.6 2      
 4           1 S2            0     0      0       1  799          5.9 2      
 5           1 H1            0     0      1       0  599          5.2 2      
 6           1 H2            1     0      1       0  699          5.7 2      
 7           2 A1            0     1      0       0  749          5.5 2      
 8           2 A2            0     1      0       0  899          5.8 2      
 9           2 S1            0     0      0       1  699          5.6 2      
10           2 S2            0     0      0       1  799          5.9 2      
11           2 H1            0     0      1       0  539.         5.2 2      
12           2 H2            1     0      1       0  699          5.7 2      
13           3 A1            1     1      0       0  749          5.5 3      
14           3 A2            0     1      0       0  899          5.8 3      
15           3 S1            0     0      0       1  699          5.6 3      
16           3 S2            0     0      0       1  719.         5.9 3      
17           3 H1            0     0      1       0  599          5.2 3      
18           3 H2            0     0      1       0  699          5.7 3      
19           4 A1            0     1      0       0  799          5.8 2      
20           4 A2            0     1      0       0  899          6.1 2      
# ℹ 1 more variable: total_minutes &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then estimating demand for each year separately, since customer preferences may</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#have changed across product generations</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's split the big (n*6 row) dataframe into 3 dataframes, one for each year.</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    sub1 <span class="ot">&lt;-</span> mnl_dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(customer_id <span class="sc">%in%</span> <span class="fu">which</span>(cust_dat<span class="sc">$</span>years_ago <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    sub2 <span class="ot">&lt;-</span> mnl_dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(customer_id <span class="sc">%in%</span> <span class="fu">which</span>(cust_dat<span class="sc">$</span>years_ago <span class="sc">==</span> <span class="dv">2</span>))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    sub3 <span class="ot">&lt;-</span> mnl_dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(customer_id <span class="sc">%in%</span> <span class="fu">which</span>(cust_dat<span class="sc">$</span>years_ago <span class="sc">==</span> <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3 -----</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># converting the 3 'sub' dataframes into mlogit.data objects.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># To do that, need to specify the y variable (choice), whether our datasets</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># have 6 times as many rows as the original data (shape="long") or 6 times as</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># many columns (shape="wide"), and the id variable that groups the set of</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># phones from one choice-occasion together (our "customer_id" variable).</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    mdat1 <span class="ot">&lt;-</span> <span class="fu">mlogit.data</span>(sub1, <span class="at">choice =</span> <span class="st">"choice"</span>, <span class="at">shape =</span> <span class="st">"long"</span>, <span class="at">chid.var =</span> <span class="st">"customer_id"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    mdat2 <span class="ot">&lt;-</span> <span class="fu">mlogit.data</span>(sub2, <span class="at">choice =</span> <span class="st">"choice"</span>, <span class="at">shape =</span> <span class="st">"long"</span>, <span class="at">chid.var =</span> <span class="st">"customer_id"</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    mdat3 <span class="ot">&lt;-</span> <span class="fu">mlogit.data</span>(sub3, <span class="at">choice =</span> <span class="st">"choice"</span>, <span class="at">shape =</span> <span class="st">"long"</span>, <span class="at">chid.var =</span> <span class="st">"customer_id"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then I will use customer that bought phones last year </span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#(ie, sub1 and mdat1 where "years_ago" == 1) as an example.</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate market shares ----</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculating product-level and brand-level market shares:</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    brand_shares <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">filter</span>(years_ago <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">count</span>(brand) <span class="sc">|&gt;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">mutate</span>(<span class="at">shr =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    brand_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  brand       n   shr
  &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt;
1 apple     346 0.356
2 huawei    284 0.292
3 samsung   342 0.352</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>    product_shares <span class="ot">&lt;-</span> cust_dat <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">filter</span>(years_ago <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">count</span>(phone_id) <span class="sc">|&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">mutate</span>(<span class="at">shr =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n))</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    product_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  phone_id     n    shr
  &lt;chr&gt;    &lt;int&gt;  &lt;dbl&gt;
1 A1         233 0.240 
2 A2         113 0.116 
3 H1         144 0.148 
4 H2         140 0.144 
5 S1         246 0.253 
6 S2          96 0.0988</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit basic (brand-intercept only) model -----</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Always start simple. For the first model, I will fit a model where our "X"</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variables are just the binary dummy variables that indicate brand.</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to leave out one phone as a "baseline" and omit an intercept, so that this</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model is "identified" (ie, can be estimated).Omiting the intercept by</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># including the bar-zero ("|0") in the formula:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    out1 <span class="ot">&lt;-</span> <span class="fu">mlogit</span>(choice <span class="sc">~</span> apple <span class="sc">+</span> samsung <span class="sc">|</span> <span class="dv">0</span>, <span class="at">data =</span> mdat1)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(out1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mlogit(formula = choice ~ apple + samsung | 0, data = mdat1, 
    method = "nr")

Frequencies of alternatives:choice
       1        2        3        4        5        6 
0.239712 0.116255 0.253086 0.098765 0.148148 0.144033 

nr method
3 iterations, 0h:0m:0s 
g'(-H)^-1g = 0.00849 
successive function values within tolerance limits 

Coefficients :
        Estimate Std. Error z-value Pr(&gt;|z|)  
apple   0.197455   0.080071  2.4660  0.01366 *
samsung 0.185829   0.080281  2.3147  0.02063 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood: -1737.8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The coefficients for the Apple and Samsung brand dummies are</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># positive and statistically significantly different from zero. Those are in</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># comparison to the Huawai coefficient which is restricted to zero for identification.</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># But what do those parameters mean?</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then using these coefficients to calculate the model's estimate of brand-level</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># market shares. </span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print the coefficients</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">coef</span>(out1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    apple   samsung 
0.1974553 0.1858286 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print the brand market shares estimated from the model</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>        coefs1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">huawei =</span> <span class="dv">0</span>, <span class="fu">coef</span>(out1))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        shares1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(coefs1) <span class="sc">/</span> <span class="fu">sum</span>(<span class="fu">exp</span>(coefs1)) <span class="co"># 𝑒^Vi/∑_j𝑒^Vj</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">round</span>(shares1, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> huawei   apple samsung 
  0.292   0.356   0.352 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print the actual brand market shares</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>        brand_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  brand       n   shr
  &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt;
1 apple     346 0.356
2 huawei    284 0.292
3 samsung   342 0.352</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print the actual product market shares</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>        product_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  phone_id     n    shr
  &lt;chr&gt;    &lt;int&gt;  &lt;dbl&gt;
1 A1         233 0.240 
2 A2         113 0.116 
3 H1         144 0.148 
4 H2         140 0.144 
5 S1         246 0.253 
6 S2          96 0.0988</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>        <span class="co"># clean up</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rm</span>(coefs1, shares1)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The model fits the intercepts in order to **exactly**</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># match the brand-level market shares from the data. However, it does not match</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the product-level market shares.</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second, and this is more subtle but general, the sign and magnitude of the</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># coefficients inform of us the impact on estimated market shares: larger positive</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># coefficients predict larger market shares. Apple has the largest coefficient</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and thus the largest estimated market share.</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># More illustration, calculate two measures of model fit/performance.</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># using custom functions to make the calculations easy to repeat.</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Model Fit Functions -----</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The first is the "hit rate" which is the percent of choices the model</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># correctly predicts. Creating custom functions for the brand hit rate</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and the product hit rate. This measure is something that probably</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># commonly encounter in industry according to text book, as it has a straightforward interpretation.</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    brand_hit_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(data, model) {</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># here I use the model to predict which phone maximizes each customer's utility</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        preds <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">predict</span>(model, <span class="at">newdata =</span> data), <span class="dv">1</span>, which.max)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># here I construct a vector of customer choices for comparisons to predictions</span></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        actuals <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">matrix</span>(data<span class="sc">$</span>choice, <span class="at">ncol =</span> <span class="dv">6</span>, <span class="at">byrow =</span> T), <span class="dv">1</span>, which.max)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># here I compare the model's predictions to the data</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(<span class="fu">ceiling</span>(preds <span class="sc">/</span> <span class="dv">2</span>) <span class="sc">==</span> <span class="fu">ceiling</span>(actuals <span class="sc">/</span> <span class="dv">2</span>))</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># now do the same steps but at the phone level</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>    product_hit_rate <span class="ot">&lt;-</span> <span class="cf">function</span>(data, model) {</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>        preds <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">predict</span>(model, <span class="at">newdata =</span> data), <span class="dv">1</span>, which.max)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        actuals <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">matrix</span>(data<span class="sc">$</span>choice, <span class="at">ncol =</span> <span class="dv">6</span>, <span class="at">byrow =</span> T), <span class="dv">1</span>, which.max)</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(preds <span class="sc">==</span> actuals)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The second measure of model fit is the likelihood ratio index </span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (also called McFadden's pseudo # R-squared). </span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Like R^2 from linear regression, this metric ranges from</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># zero to one, and the interpretation is the degree of improvement over the</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># random guessing about consumer choices</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    ll_ratio <span class="ot">&lt;-</span> <span class="cf">function</span>(data, model) {</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>        N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(model<span class="sc">$</span>probabilities)</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>        J <span class="ot">&lt;-</span> <span class="fu">ncol</span>(model<span class="sc">$</span>probabilities)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>        ll0 <span class="ot">&lt;-</span> N <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">/</span> J)   <span class="co"># this is the null model for comparison</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>        ll1 <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(model<span class="sc">$</span>logLik)   <span class="co"># this is lnL(beta) from slides</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>        <span class="dv">1</span> <span class="sc">-</span> ll1 <span class="sc">/</span> ll0</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Then calculating the brand hit rate and the likelihood ratio index for</span></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mnl model. </span></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">brand_hit_rate</span>(mdat1, out1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3559671</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">product_hit_rate</span>(mdat1, out1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2397119</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ll_ratio</span>(mdat1, out1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.002181383</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The simple/naive "model" is that each brand is chosen 33.3% (=1/3).</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The brand hit rate is about 35.6%, which is just a bit better than the naive approach.</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The likelihood ratio index confirms that the model is not much better than random guessing.</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># One way can improve a model's performance is to give it more complete data </span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (ie, more variables). </span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Price -----</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adding the price variable to the model and see what happens:</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    out2 <span class="ot">&lt;-</span> <span class="fu">mlogit</span>(choice <span class="sc">~</span> apple <span class="sc">+</span> samsung <span class="sc">+</span> price <span class="sc">|</span> <span class="dv">0</span>, <span class="at">data =</span> mdat1)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(out2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mlogit(formula = choice ~ apple + samsung + price | 0, data = mdat1, 
    method = "nr")

Frequencies of alternatives:choice
       1        2        3        4        5        6 
0.239712 0.116255 0.253086 0.098765 0.148148 0.144033 

nr method
4 iterations, 0h:0m:0s 
g'(-H)^-1g = 0.000129 
successive function values within tolerance limits 

Coefficients :
           Estimate  Std. Error  z-value  Pr(&gt;|z|)    
apple    1.05865609  0.10876661   9.7333 &lt; 2.2e-16 ***
samsung  0.63450323  0.08959903   7.0816 1.425e-12 ***
price   -0.00619721  0.00058165 -10.6545 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood: -1677</code></pre>
</div>
</div>
</section>
<section id="some-observations" class="level2">
<h2 class="anchored" data-anchor-id="some-observations">Some Observations</h2>
<p>Firstly, it is observed that the coefficients for Apple and Samsung have significantly increased. This suggests that, when price is held constant, consumers demonstrate a stronger preference for Apple and Samsung over Huawei. Market share data indicates that Apple and Samsung dominate over Huawei, which can be attributed to both brand loyalty and pricing strategies. Huawei’s devices, often priced lower than those of Apple and Samsung, achieve competitive market shares due in part to a positive brand perception of Apple and Samsung. This is counterbalanced by the negative impact of their higher pricing.</p>
<p>Secondly, the negative coefficient associated with price implies that higher prices result in decreased utility for consumers and, consequently, lower market shares. This relationship is intuitive and aligns with economic principles.</p>
<p>Thirdly, the presence of smaller p-values in the analysis may indicate that the current model provides a better fit to the observed data compared to previous models.</p>
</section>
<section id="testing-for-the-better-fitting-hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="testing-for-the-better-fitting-hypothesis">Testing for the Better Fitting Hypothesis</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's test that "better fitting" hypothesis by calculating the hit rates and</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># likelihood ratio index for this model.</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">brand_hit_rate</span>(mdat1, out2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3549383</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>        <span class="fu">product_hit_rate</span>(mdat1, out2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2479424</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ll_ratio</span>(mdat1, out2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03709335</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Got a small improvement in brand hit rate which is now 35.6%, compared to</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the prior model's brand hit rate of 35.5%.</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Got a product hit rate of 24.8%, better than simpler model's product hit rate </span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># of 24.0%</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># That improvement is noticeable in the likelihood ratio statistic. .037 is much better</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># than our previous fit of .002</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Let's see what has happened to the brands' market share predictions</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First need to predict phone shares, then sum over phones to predict brand shares</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">#predict phone shares</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>        shares2p <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(<span class="fu">predict</span>(out2, <span class="at">newdata =</span> mdat1))</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(shares2p) <span class="ot">&lt;-</span> sub1 <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">6</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(phone_id)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">#sum over phones to predict brand shares</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        shares2b <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">matrix</span>(shares2p, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(shares2b) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"apple"</span>, <span class="st">"samsung"</span>, <span class="st">"huawei"</span>)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(shares2b, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  apple samsung  huawei 
  0.356   0.352   0.292 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>    brand_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  brand       n   shr
  &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt;
1 apple     346 0.356
2 huawei    284 0.292
3 samsung   342 0.352</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...still exactly match actual brand-level market shares</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(shares2p, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   A1    A2    S1    S2    H1    H2 
0.254 0.102 0.227 0.124 0.168 0.124 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>    product_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  phone_id     n    shr
  &lt;chr&gt;    &lt;int&gt;  &lt;dbl&gt;
1 A1         233 0.240 
2 A2         113 0.116 
3 H1         144 0.148 
4 H2         140 0.144 
5 S1         246 0.253 
6 S2          96 0.0988</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...and now I have product-level market share estimates that better reflect</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the actual product-level market shares, albeit not perfectly.</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># That's probably because I don't have any product-specific attributes or dummies.</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Size -----</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Improve the model further by fitting MNL with brand, price, and size</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    out3 <span class="ot">&lt;-</span> <span class="fu">mlogit</span>(choice <span class="sc">~</span> apple <span class="sc">+</span> samsung <span class="sc">+</span> price <span class="sc">+</span> screen_size <span class="sc">|</span> <span class="dv">0</span>, <span class="at">data =</span> mdat1)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(out3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mlogit(formula = choice ~ apple + samsung + price + screen_size | 
    0, data = mdat1, method = "nr")

Frequencies of alternatives:choice
       1        2        3        4        5        6 
0.239712 0.116255 0.253086 0.098765 0.148148 0.144033 

nr method
4 iterations, 0h:0m:0s 
g'(-H)^-1g = 0.000119 
successive function values within tolerance limits 

Coefficients :
              Estimate Std. Error z-value  Pr(&gt;|z|)    
apple        0.9983423  0.1443294  6.9171 4.610e-12 ***
samsung      0.6357234  0.0894121  7.1100 1.160e-12 ***
price       -0.0056366  0.0010562 -5.3366 9.473e-08 ***
screen_size -0.1416883  0.2226515 -0.6364    0.5245    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood: -1676.8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">brand_hit_rate</span>(mdat1, out3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3549383</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">product_hit_rate</span>(mdat1, out3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2479424</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ll_ratio</span>(mdat1, out3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.03721033</code></pre>
</div>
</div>
</section>
<section id="some-observations-1" class="level2">
<h2 class="anchored" data-anchor-id="some-observations-1">Some Observations</h2>
<p>The “size” variable’s coefficient lacks statistical significance, and the hit rates remain virtually the same. This indicates that the “size” variable might not be contributing significantly to the model. The likely reason could be the high correlation between screen size and price, suggesting that the price variable may already account for most of the information provided by the size variable.</p>
<p>Interestingly, the coefficient for price increased from -0.006 to -0.005, implying that screen size has an influence on price that was not captured in the previous model. This could mean that the previous model suffered from endogeneity issues.</p>
<p>Specifically, the original price coefficient of -0.006 was not solely due to price but also incorporated an effect from screen size. After adjusting for screen size, the price coefficient shifted to -0.005.</p>
<p>Recalling our market mapping exercise, Samsung’s large phones, which featured very big screens, had a low market share. This observation suggests that it might be beneficial to estimate intercepts specific to each phone model instead of using a common screen size parameter for all phones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Product-Specific Intercepts -----</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now fit the MNL model with product-specific intercepts and price</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Now, instead of brand dummy variables, I will use product dummy variables.</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># So there will be 5 dummies (one phone has to be set to 0 for identification).</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Notice that because size does not vary for a given phone, so cannot include</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it in the model because it would be perfectly collinear with the phone dummies.</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    out4 <span class="ot">&lt;-</span> <span class="fu">mlogit</span>(choice <span class="sc">~</span> phone_id <span class="sc">+</span> price <span class="sc">|</span> <span class="dv">0</span>, <span class="at">data =</span> mdat1)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summary</span>(out4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mlogit(formula = choice ~ phone_id + price | 0, data = mdat1, 
    method = "nr")

Frequencies of alternatives:choice
       1        2        3        4        5        6 
0.239712 0.116255 0.253086 0.098765 0.148148 0.144033 

nr method
4 iterations, 0h:0m:0s 
g'(-H)^-1g = 0.000518 
successive function values within tolerance limits 

Coefficients :
             Estimate Std. Error z-value  Pr(&gt;|z|)    
phone_idA2  0.3324964  0.2212103  1.5031  0.132819    
phone_idH1 -1.2251497  0.1724673 -7.1037 1.215e-12 ***
phone_idH2 -0.9080016  0.1303339 -6.9667 3.244e-12 ***
phone_idS1 -0.3060387  0.1124682 -2.7211  0.006506 ** 
phone_idS2 -0.5545496  0.1346713 -4.1178 3.825e-05 ***
price      -0.0071582  0.0012933 -5.5346 3.119e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Log-Likelihood: -1668.6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Notice that many of the coefficients are negative. This is because the small</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apple phone is the reference product (simply because it's listed first), so</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># all phones with smaller market shares than Apple small have lower parameter estimates</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Notice also that price coefficient has changed yet again to -0.007. Specifically,</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the screen size variable in the prior model was capturing the average effect</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># of screen size across the 3 brands.  Now, have specified a more flexible model</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in which screen size and all other product-specific differences are accounted</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for by the product dummies</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the fit metrics</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">brand_hit_rate</span>(mdat1, out4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.367284</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>        <span class="fu">product_hit_rate</span>(mdat1, out4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2685185</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ll_ratio</span>(mdat1, out4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0419071</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The brand hit rate improved 1% from 35.5% to 36.7%.</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The product hit rate improved 2% from 24.8% to 26.9%.</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The improvement comes from the flexibility of the model to allow for different</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># preferences for small and large phones *within* a brand.</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LL Ratio is now up to .042, 21x larger than the .002 in the brand-only model</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check the brand-level market shares</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    shares4p <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(<span class="fu">predict</span>(out4, <span class="at">newdata =</span> mdat1))</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(shares4p) <span class="ot">&lt;-</span> sub1 <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">6</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(phone_id)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    shares4b <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">matrix</span>(shares4p, <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(shares4b) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"apple"</span>, <span class="st">"samsung"</span>, <span class="st">"huawei"</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(shares4b, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  apple samsung  huawei 
  0.356   0.352   0.292 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>    brand_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  brand       n   shr
  &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt;
1 apple     346 0.356
2 huawei    284 0.292
3 samsung   342 0.352</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># still exactly match actual brand-level market shares</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(shares4p, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   A1    A2    S1    S2    H1    H2 
0.240 0.116 0.253 0.099 0.148 0.144 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>    product_shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  phone_id     n    shr
  &lt;chr&gt;    &lt;int&gt;  &lt;dbl&gt;
1 A1         233 0.240 
2 A2         113 0.116 
3 H1         144 0.148 
4 H2         140 0.144 
5 S1         246 0.253 
6 S2          96 0.0988</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and now it's able to exactly match product-level market shares.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next step involves enhancing our model by incorporating customer-specific heterogeneity. While the model currently performs well on an aggregate level, assessing and tailoring it to individual variations will potentially increase its accuracy and relevance for specific customers. This could involve adding parameters or features that capture unique behaviors or preferences of different customer segments</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>